name: Setup Git Credentials on Server

on:
  workflow_dispatch:

jobs:
  setup:
    name: Configure Git Credentials
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ” Setup Git Credentials on Server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          envs: GH_PAT
          script: |
            cd /opt/mdclodging

            echo "ðŸ”§ Configuring git credential helper..."
            git config --global credential.helper store

            echo "ðŸ” Setting up GitHub credentials..."
            # Create credentials file with token
            echo "https://oauth2:${{ secrets.GH_PAT }}@github.com" > ~/.git-credentials
            chmod 600 ~/.git-credentials

            echo ""
            echo "ðŸ“‹ Current remote configuration:"
            git remote -v

            echo ""
            echo "ðŸ§ª Testing git fetch with credentials..."
            git fetch origin

            echo ""
            echo "âœ… Git credentials configured successfully!"
            echo "Current commit: $(git rev-parse HEAD | cut -c1-7)"
            echo "Latest commit: $(git rev-parse origin/master | cut -c1-7)"

      - name: âœ… Setup Complete
        if: success()
        run: |
          echo "âœ… Git credentials have been configured on the production server"
          echo "The deploy script should now work correctly"
