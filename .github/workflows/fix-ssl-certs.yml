name: Fix SSL Certificates

on:
  workflow_dispatch:

jobs:
  fix:
    name: Fix SSL Certificate Paths
    runs-on: ubuntu-latest

    steps:
      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/prod_key
          chmod 600 ~/.ssh/prod_key
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: Fix SSL certificate files
        run: |
          ssh -i ~/.ssh/prod_key ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
            set -e

            echo "=== Removing old symlinks ==="
            cd /opt/mdclodging/nginx/ssl
            rm -f fullchain.pem privkey.pem

            echo "=== Copying actual certificate files ==="
            sudo cp /etc/letsencrypt/live/app.aneldida.com/fullchain.pem fullchain.pem
            sudo cp /etc/letsencrypt/live/app.aneldida.com/privkey.pem privkey.pem
            sudo chown deploy:deploy fullchain.pem privkey.pem
            sudo chmod 644 fullchain.pem
            sudo chmod 600 privkey.pem

            echo "=== Verifying certificate files ==="
            ls -la /opt/mdclodging/nginx/ssl/
            file fullchain.pem
            file privkey.pem

            echo -e "\n=== Restarting nginx container ==="
            docker restart mdclodging_nginx

            echo -e "\n=== Waiting for nginx to start ==="
            sleep 5

            echo -e "\n=== Checking nginx status ==="
            docker ps --filter 'name=mdclodging_nginx'

            echo -e "\n=== Checking nginx logs ==="
            docker logs mdclodging_nginx --tail 30

            echo -e "\n=== Testing nginx config ==="
            docker exec mdclodging_nginx nginx -t 2>&1 || echo "Config test failed"

            echo -e "\n=== Testing HTTPS locally ==="
            sleep 3
            curl -k -I https://localhost 2>&1 | head -10 || echo "HTTPS test failed"
          EOF

      - name: Test external HTTPS
        run: |
          echo "=== Testing external HTTPS access ==="
          sleep 5

          echo "Testing app.aneldida.com..."
          curl -I https://app.aneldida.com 2>&1 | head -10 || echo "Failed"

          echo -e "\nTesting api.aneldida.com..."
          curl -I https://api.aneldida.com/health 2>&1 | head -10 || echo "Failed"
