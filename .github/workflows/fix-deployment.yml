name: Fix Production Deployment

on:
  workflow_dispatch:

jobs:
  fix:
    name: Fix Server and Deploy
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ”§ Fix Server and Update Code
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd /opt/mdclodging

            echo "ğŸ“‹ Current status:"
            git status --short

            echo ""
            echo "ğŸ§¹ Removing nginx folder with sudo (if exists)..."
            sudo rm -rf nginx/ 2>/dev/null || echo "nginx folder already removed or doesn't exist"

            echo ""
            echo "ğŸ“¥ Fetching latest code from GitHub..."
            git fetch origin

            echo ""
            echo "ğŸ”„ Resetting to origin/master (this will discard local changes)..."
            git reset --hard origin/master

            echo ""
            echo "ğŸ§¹ Removing any remaining untracked files..."
            git clean -fd

            echo ""
            echo "âœ… Server code updated successfully!"
            echo "Current commit: $(git rev-parse HEAD | cut -c1-7)"
            echo "Expected commit: d9252be"

            echo ""
            echo "ğŸ“‹ Verifying deploy script update..."
            if grep -q "git reset --hard origin/master" scripts/deploy.sh; then
              echo "âœ… Deploy script has been updated with git reset"
            else
              echo "âš ï¸  Deploy script still uses git pull"
            fi

      - name: ğŸš€ Run Deployment
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd /opt/mdclodging

            echo "ğŸš€ Running deployment script..."
            bash scripts/deploy.sh

      - name: âœ… Deployment Complete
        if: success()
        run: |
          echo "âœ… Server has been fixed and deployed successfully"
          echo "The subdomain field should now be removed from app.aneldida.com/login"
          echo "Future deployments will work automatically using the Deploy to Production workflow"
