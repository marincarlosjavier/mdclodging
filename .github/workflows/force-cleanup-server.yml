name: Force Cleanup Server

on:
  workflow_dispatch:

jobs:
  cleanup:
    name: Force Remove Files with Sudo
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ§¹ Force Cleanup with Sudo
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd /opt/mdclodging

            echo "ðŸ“‹ Current status:"
            git status

            echo ""
            echo "ðŸ§¹ Moving nginx folder out of the way..."
            sudo mv nginx /tmp/nginx-backup-$(date +%Y%m%d-%H%M%S) 2>/dev/null || echo "nginx folder doesn't exist or already moved"

            echo ""
            echo "ðŸ”„ Resetting git to clean state..."
            git reset --hard HEAD
            git clean -fd

            echo ""
            echo "ðŸ“¥ Pulling latest changes..."
            git pull origin master

            echo ""
            echo "âœ… Cleanup and update complete!"
            echo "Current commit: $(git rev-parse HEAD | cut -c1-7)"

      - name: âœ… Cleanup Complete
        if: success()
        run: |
          echo "âœ… Server cleaned up and updated successfully"
          echo "The nginx folder has been backed up to /tmp/"
