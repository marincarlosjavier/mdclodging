name: Quick HTTPS Fix

on:
  workflow_dispatch:

jobs:
  fix:
    runs-on: ubuntu-latest
    steps:
      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/prod_key
          chmod 600 ~/.ssh/prod_key
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: Fix HTTPS
        run: |
          ssh -i ~/.ssh/prod_key ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} 'bash -s' << 'EOF'
            cd /opt/mdclodging/nginx

            # Update nginx.conf SSL paths
            sed -i 's|/etc/nginx/ssl/fullchain.pem|/etc/letsencrypt/live/app.aneldida.com/fullchain.pem|g' nginx.conf
            sed -i 's|/etc/nginx/ssl/privkey.pem|/etc/letsencrypt/live/app.aneldida.com/privkey.pem|g' nginx.conf

            # Recreate nginx
            docker stop mdclodging_nginx && docker rm mdclodging_nginx
            docker run -d --name mdclodging_nginx --network mdclodging_mdclodging_network \
              -p 80:80 -p 443:443 \
              -v /opt/mdclodging/nginx/nginx.conf:/etc/nginx/nginx.conf:ro \
              -v /etc/letsencrypt:/etc/letsencrypt:ro \
              -v certbot_data:/var/www/certbot:ro \
              --restart unless-stopped nginx:alpine

            sleep 5
            docker ps --filter 'name=mdclodging_nginx'
            docker exec mdclodging_nginx nginx -t
EOF
