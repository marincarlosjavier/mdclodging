name: Force Update Server Code

on:
  workflow_dispatch:

jobs:
  update:
    name: Force Git Reset on Server
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ”„ Force Update Server Code
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd /opt/mdclodging

            echo "ğŸ“‹ Current status:"
            git status --short

            echo ""
            echo "ğŸ“¥ Fetching latest code..."
            git fetch origin

            echo ""
            echo "ğŸ”„ Force reset to origin/master (this will discard local changes)..."
            git reset --hard origin/master

            echo ""
            echo "âœ… Server code updated successfully!"
            echo "Current commit: $(git rev-parse HEAD | cut -c1-7)"
            echo ""

            echo "ğŸ“‹ Verifying deploy script update..."
            if grep -q "git reset --hard origin/master" scripts/deploy.sh; then
              echo "âœ… Deploy script has been updated with git reset"
            else
              echo "âš ï¸  Deploy script still uses git pull"
            fi

      - name: âœ… Update Complete
        if: success()
        run: |
          echo "âœ… Server code has been force updated"
          echo "Now run the Deploy to Production workflow to deploy changes"
