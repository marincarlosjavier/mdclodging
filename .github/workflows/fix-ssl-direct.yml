name: Fix SSL Direct

on:
  workflow_dispatch:
  push:
    branches:
      - 'fix-ssl-direct'

jobs:
  fix-ssl:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Copy nginx config and restart
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "nginx/nginx.conf"
          target: "/opt/mdclodging/"
          overwrite: true

      - name: Restart nginx with correct config
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            docker stop mdclodging_nginx && docker rm mdclodging_nginx
            docker run -d --name mdclodging_nginx --network mdclodging_mdclodging_network -p 80:80 -p 443:443 -v /opt/mdclodging/nginx/nginx.conf:/etc/nginx/nginx.conf:ro -v /etc/letsencrypt:/etc/letsencrypt:ro -v certbot_data:/var/www/certbot:ro --restart unless-stopped nginx:alpine
            sleep 8
            docker ps --filter 'name=mdclodging_nginx'
            docker logs mdclodging_nginx --tail 20
            docker exec mdclodging_nginx nginx -t
            curl -k -I https://localhost | head -10
